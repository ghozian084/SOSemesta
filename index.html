<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Competition Information</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom Tailwind colors for Kurasi */
        .text-kurasi-kuning { color: #facc15; } /* Yellow */
        .text-kurasi-hijau { color: #22c55e; } /* Green */
        .text-kurasi-biru { color: #3b82f6; }  /* Blue */
        .text-kurasi-merah { color: #ef4444; } /* Red */

        .bg-kurasi-kuning-light { background-color: #fef08a; } /* Light Yellow */
        .bg-kurasi-hijau-light { background-color: #dcfce7; } /* Light Green */
        .bg-kurasi-biru-light { background-color: #dbeafe; }  /* Light Blue */
        .bg-kurasi-merah-light { background-color: #fee2e2; } /* Light Red */
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Navigation Bar -->
        <nav class="bg-white rounded-xl shadow-lg p-4 mb-6 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="flex items-center space-x-4">
                <a href="#" class="flex items-center text-lg font-medium text-gray-800 hover:text-blue-600 transition-colors duration-200">
                    üè† Home
                </a>
                <a href="https://forms.gle/vPV2waaJfPzUwrwGA" target="_blank" class="flex items-center text-lg font-medium text-gray-800 hover:text-blue-600 transition-colors duration-200">
                    Input Kompetisi
                </a>
            </div>
            <button class="flex items-center text-lg font-medium text-gray-500 cursor-not-allowed" disabled>
                Input Perizinan Lomba (SOON)
            </button>
        </nav>

        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">SOS Competition Information</h1>
        <p class="text-gray-600 mb-6">Explore the latest competition details.</p>

        <!-- Control Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <div class="flex items-center space-x-2">
                <label for="filter" class="font-medium text-gray-700">Filter by Bidang Lomba:</label>
                <select id="filter" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All</option>
                </select>
            </div>
            <button id="refreshButton" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 transition-colors duration-200">
                Refresh Data from Google Sheet
            </button>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="errorText"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="this.parentElement.style.display='none'">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.03a1.2 1.2 0 1 1-1.701-1.684l3.197-3.048-3.197-3.048a1.2 1.2 0 1 1 1.701-1.684L10 8.181l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697L11.819 10l3.03 2.651a1.2 1.2 0 0 1 0 1.697z"/></svg>
            </span>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center text-gray-500 text-lg font-medium p-8 hidden">
            <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2">Loading data...</p>
        </div>

        <!-- Competition Cards -->
        <div id="cardContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- Modal Pop-up -->
    <div id="modal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 pt-16">
        <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 m-4 transform transition-transform duration-300 scale-95 md:scale-100">
            <button id="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition-colors duration-200">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <div id="modalContent" class="space-y-4">
                <div id="modalImageContainer" class="rounded-lg overflow-hidden cursor-pointer">
                    <img id="modalImage" src="" alt="Competition Image" class="w-full h-full object-cover">
                </div>
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800"></h2>
                <div id="modalDetails" class="text-gray-600 space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheet API Configuration
        const SPREADSHEET_ID = '1h42ukgC8xPx79hR9WbNFppXUf-cWGyqqtMAMtw4vhBc';
        const API_KEY = 'AIzaSyAM7Gfodn3_HR0Qmv20auf_D-bu5ik8AL4';
        const RANGE = 'Competition!A1:M100'; 

        // DOM Elements
        const cardContainer = document.getElementById('cardContainer');
        const filterDropdown = document.getElementById('filter');
        const refreshButton = document.getElementById('refreshButton');
        const loadingMessage = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        const closeModalButton = document.getElementById('closeModal');
        const PLACEHOLDER_IMAGE = 'https://placehold.co/400x200/cccccc/333333?text=Image+Load+Failed';

        // Global variable to store all fetched data
        let allData = [];

        /**
         * Shows the loading indicator and clears existing cards.
         */
        function showLoading() {
            loadingMessage.classList.remove('hidden');
            cardContainer.innerHTML = '';
            errorMessage.classList.add('hidden'); // Hide any previous error message
        }

        /**
         * Hides the loading indicator.
         */
        function hideLoading() {
            loadingMessage.classList.add('hidden');
        }

        /**
         * Displays an error message to the user.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            hideLoading(); // Hide loading indicator if an error occurs
        }

        /**
         * Converts a Google Drive sharing URL to a direct image URL.
         * @param {string} driveUrl - The Google Drive sharing URL.
         * @returns {string} The direct image URL or a placeholder if conversion fails.
         */
        function getDirectImageUrl(driveUrl) {
            if (!driveUrl || driveUrl.includes(PLACEHOLDER_IMAGE)) {
                return PLACEHOLDER_IMAGE;
            }
            try {
                // Regex to extract file ID from common Google Drive sharing URLs
                const idMatch = driveUrl.match(/(?:id=|file\/d\/)([^&/]+)/);
                if (idMatch && idMatch[1]) {
                    const fileId = idMatch[1];
                    // Construct a direct image URL for Google Photos/Drive content
                    return `https://lh3.googleusercontent.com/d/${fileId}=s1000`; // s1000 for max 1000px dimension
                }
            } catch (error) {
                console.error('Failed to convert URL:', error);
            }
            return PLACEHOLDER_IMAGE;
        }

        /**
         * Processes raw Google Sheet values into a clean array of objects.
         * The first row is used as headers.
         * @param {Array<Array<string>>} values - Raw data from the Google Sheet API.
         * @returns {Array<Object>} An array of objects, where each object represents a row.
         */
        function processData(values) {
            if (!values || values.length < 2) {
                return []; // No data or only headers
            }
            const headers = values[0].map(header => header.trim());
            return values.slice(1).map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || ''; // Use empty string for missing values
                });
                return obj;
            });
        }

        /**
         * Formats a date string into Indonesian locale (e.g., "29 Agustus 2025").
         * Tries to parse 'dd/mm/yyyy' explicitly first, then other common date formats.
         * @param {string} dateString - The date string to format.
         * @returns {string} The formatted date string or 'N/A' if invalid.
         */
        function formatDateToIndonesian(dateString) {
            if (!dateString) return 'N/A';
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            try {
                let date;

                // Attempt to parse dd/mm/yyyy format first
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                    const year = parseInt(parts[2], 10);
                    date = new Date(year, month, day);

                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('id-ID', options);
                    }
                }
                
                // Fallback to standard date parsing if dd/mm/yyyy failed or wasn't the format
                date = new Date(dateString);
                
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('id-ID', options);
                } else {
                    return dateString; // Return original string if unable to parse
                }
            } catch (e) {
                console.error("Error formatting date:", dateString, e);
                return dateString; // Fallback to original string on error
            }
        }

        /**
         * Formats a number to Indonesian Rupiah (e.g., Rp 150.000).
         * @param {string|number} amount - The amount to format.
         * @returns {string} The formatted Rupiah string or 'N/A' if invalid.
         */
        function formatToRupiah(amount) {
            if (!amount) return 'N/A';
            const num = parseFloat(amount.toString().replace(/[^0-9,-]/g, '').replace(',', '.')); // Handle comma as decimal separator
            if (isNaN(num)) return amount; // Return original if not a valid number
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0, // No decimal for whole rupiah
                maximumFractionDigits: 0,
            }).format(num);
        }

        /**
         * Returns Tailwind CSS color classes for Kurasi text and background.
         * @param {string} kurasiValue - The value from the 'Kurasi' column.
         * @returns {Object} An object with textClass and bgClass.
         */
        function getKurasiColorClass(kurasiValue) {
            const lowerCaseValue = kurasiValue ? kurasiValue.toLowerCase() : '';
            switch (lowerCaseValue) {
                case 'kuning':
                    return { textClass: 'text-kurasi-kuning', bgClass: 'bg-kurasi-kuning-light' };
                case 'hijau':
                    return { textClass: 'text-kurasi-hijau', bgClass: 'bg-kurasi-hijau-light' };
                case 'biru':
                    return { textClass: 'text-kurasi-biru', bgClass: 'bg-kurasi-biru-light' };
                case 'merah':
                    return { textClass: 'text-kurasi-merah', bgClass: 'bg-kurasi-merah-light' };
                default:
                    return { textClass: 'text-gray-600', bgClass: 'bg-gray-200' };
            }
        }


        /**
         * Renders competition cards in the cardContainer based on the provided data.
         * @param {Array<Object>} data - An array of competition data objects.
         */
        function renderCards(data) {
            cardContainer.innerHTML = ''; // Clear existing cards
            if (data.length === 0) {
                cardContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full mt-8">No data available for the current filter.</p>';
                return;
            }

            data.forEach(item => {
                const kurasiClasses = getKurasiColorClass(item.Kurasi);
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden cursor-pointer group'; // Added 'group' for image hover effect
                card.innerHTML = `
                    <div class="h-48 bg-gray-200 overflow-hidden relative">
                        <img class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" 
                             src="${getDirectImageUrl(item.Poster)}" 
                             alt="${item['Nama Kompetisi'] || 'Competition Image'}" 
                             loading="lazy" 
                             onerror="this.src='${PLACEHOLDER_IMAGE}'">
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 truncate">${item['Nama Kompetisi'] || 'No Title'}</h3>
                        <p class="text-sm text-gray-500 line-clamp-2">${item.Deskripsi || 'No description available.'}</p>
                        <div class="flex flex-wrap mt-3 gap-2">
                            ${item['Bidang Lomba'] ? `<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${item['Bidang Lomba']}</span>` : ''}
                            ${item.Kurasi ? `<span class="${kurasiClasses.bgClass} ${kurasiClasses.textClass} text-xs font-medium px-2.5 py-0.5 rounded-full">${item.Kurasi}</span>` : ''}
                            ${item['Deadline Pendaftaran'] ? `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Daftar: ${formatDateToIndonesian(item['Deadline Pendaftaran'])}</span>` : ''}
                            ${item['Tanggal Pelaksanaan'] ? `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Pelaksanaan: ${formatDateToIndonesian(item['Tanggal Pelaksanaan'])}</span>` : ''}
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => openModal(item));
                cardContainer.appendChild(card);
            });
        }

        /**
         * Populates the filter dropdown with unique 'Bidang Lomba' values from the fetched data.
         */
        function populateFilterDropdown() {
            // Get unique 'Bidang Lomba' values, filter out empty ones, and sort them
            const bidangLombaValues = [...new Set(allData.map(item => item['Bidang Lomba']).filter(Boolean))].sort();
            filterDropdown.innerHTML = '<option value="">All</option>'; // Always start with 'All' option
            bidangLombaValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                filterDropdown.appendChild(option);
            });
        }

        /**
         * Filters the displayed cards based on the selected value in the dropdown.
         */
        function filterCards() {
            const selectedBidangLomba = filterDropdown.value;
            const filteredData = selectedBidangLomba === ''
                ? allData // If "All" is selected, show all data
                : allData.filter(item => item['Bidang Lomba'] === selectedBidangLomba); // Filter by selected 'Bidang Lomba'
            renderCards(filteredData);
        }

        /**
         * Opens the full-screen modal with detailed information for the selected item.
         * @param {Object} item - The data object for the selected competition.
         */
        function openModal(item) {
            document.getElementById('modalTitle').textContent = item['Nama Kompetisi'] || 'No Title';

            // Manually construct details HTML for specific fields and general ones
            let detailsHtml = ``;

            // Apply Kurasi color class
            const kurasiClasses = getKurasiColorClass(item.Kurasi);

            if (item['Bidang Lomba']) detailsHtml += `<p><strong>Bidang Lomba:</strong> ${item['Bidang Lomba']}</p>`;
            if (item.Kurasi) detailsHtml += `<p><strong>Kurasi:</strong> <span class="${kurasiClasses.textClass}">${item.Kurasi}</span></p>`;
            if (item['Deadline Pendaftaran']) detailsHtml += `<p><strong>Deadline Pendaftaran:</strong> ${formatDateToIndonesian(item['Deadline Pendaftaran'])}</p>`;
            if (item['Tanggal Pelaksanaan']) detailsHtml += `<p><strong>Tanggal Pelaksanaan:</strong> ${formatDateToIndonesian(item['Tanggal Pelaksanaan'])}</p>`;
            if (item['Tanggal Pelaksanaan (Penyisihan)']) detailsHtml += `<p><strong>Tanggal Pelaksanaan (Penyisihan):</strong> ${formatDateToIndonesian(item['Tanggal Pelaksanaan (Penyisihan)'])}</p>`;
            if (item.Biaya) detailsHtml += `<p><strong>Biaya:</strong> ${formatToRupiah(item.Biaya)}</p>`;
            if (item.Deskripsi) detailsHtml += `<p><strong>Deskripsi:</strong> ${item.Deskripsi}</p>`;

            // Ordered specific fields that appear above Info Broadcast
            if (item['Jenis Lomba']) detailsHtml += `<p><strong>Jenis Lomba:</strong> ${item['Jenis Lomba']}</p>`;
            if (item['Status Lomba']) detailsHtml += `<p><strong>Status Lomba:</strong> ${item['Status Lomba']}</p>`;
            if (item['Lokasi Lomba']) detailsHtml += `<p><strong>Lokasi Lomba:</strong> ${item['Lokasi Lomba']}</p>`;
            
            // Add clickable link for Link Daftar/Guidebook before Info Broadcast
            if (item['Link Daftar/Guidebook']) {
                const linkText = item['Link Daftar/Guidebook'];
                const urlRegex = /^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i; // Basic URL validation
                if (urlRegex.test(linkText)) {
                    detailsHtml += `<p><strong>Link Daftar/Guidebook:</strong> <a href="${linkText}" target="_blank" class="text-blue-600 hover:underline">${linkText}</a></p>`;
                } else {
                    detailsHtml += `<p><strong>Link Daftar/Guidebook:</strong> ${linkText}</p>`;
                }
            }


            // Add any other relevant fields dynamically, excluding those already handled or the image/timestamp column
            const excludedKeys = [
                'Nama Kompetisi', 'Deskripsi', 'Bidang Lomba', 
                'Deadline Pendaftaran', 'Tanggal Pelaksanaan', 'Tanggal Pelaksanaan (Penyisihan)', 
                'Kurasi', 'Poster', 'Timestamp', 'Biaya', 'Link Daftar/Guidebook', 'Info Broadcast',
                'Jenis Lomba', 'Status Lomba', 'Lokasi Lomba'
            ];
            Object.entries(item).forEach(([key, value]) => {
                if (!excludedKeys.includes(key) && value) {
                    detailsHtml += `<p><strong>${key}:</strong> ${value}</p>`;
                }
            });

            // "Info Broadcast" is the very last section
            if (item['Info Broadcast']) {
                const formattedInfoBroadcast = item['Info Broadcast'].replace(/\n/g, '<br>');
                detailsHtml += `<p><strong>Info Broadcast:</strong><br>${formattedInfoBroadcast}</p>`;
            }

            document.getElementById('modalDetails').innerHTML = detailsHtml;

            // Set modal image source and error fallback
            const modalImage = document.getElementById('modalImage');
            const originalImageUrl = item.Poster; // Use item.Poster for the modal image
            modalImage.src = getDirectImageUrl(originalImageUrl);
            modalImage.onerror = () => modalImage.src = PLACEHOLDER_IMAGE;

            // Make modal image clickable to open original Google Drive URL
            document.getElementById('modalImageContainer').onclick = () => {
                if (originalImageUrl && !originalImageUrl.includes(PLACEHOLDER_IMAGE)) {
                    window.open(originalImageUrl, '_blank');
                }
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex'); // Use flex to center the modal content
            document.body.style.overflow = 'hidden'; // Prevent scrolling the background
        }

        /**
         * Closes the full-screen modal.
         */
        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = ''; // Re-enable background scrolling
        }

        /**
         * Fetches data from Google Sheets API with exponential backoff.
         * @param {number} retries - Number of retries attempted.
         * @param {number} delay - Current delay before retry.
         */
        async function fetchDataWithBackoff(retries = 0, delay = 1000) {
            const MAX_RETRIES = 3; // Maximum number of retries
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 400 && retries < MAX_RETRIES) {
                        // For a 400 error, retry a few times as it might be a temporary network hiccup or service issue.
                        await new Promise(res => setTimeout(res, delay));
                        return fetchDataWithBackoff(retries + 1, delay * 2); // Double delay for exponential backoff
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allData = processData(data.values);
                renderCards(allData);
                populateFilterDropdown();
            } catch (error) {
                console.error('Fetch error:', error);
                let specificErrorMessage = `Failed to load data: ${error.message}.`;
                if (error.message.includes('400')) {
                    specificErrorMessage += ' The Google Sheets API is enabled, but a 400 error still indicates an issue with **spreadsheet sharing permissions** (ensure it\'s "Anyone with the link" and "Viewer") or **API key restrictions** (check HTTP referrers in Google Cloud Console). Please review these settings carefully.';
                } else {
                    specificErrorMessage += ' Please check your network connection or try refreshing.';
                }
                showError(specificErrorMessage);
            } finally {
                hideLoading(); // Hide loading indicator regardless of success or failure
            }
        }

        /**
         * Main function to fetch and render data (initiates with backoff).
         */
        async function fetchData() {
            showLoading(); // Show loading indicator
            await fetchDataWithBackoff();
        }


        // --- Event Listeners ---
        refreshButton.addEventListener('click', fetchData);
        filterDropdown.addEventListener('change', filterCards);
        closeModalButton.addEventListener('click', closeModal);

        // Close modal when clicking outside the modal content
        modal.addEventListener('click', (e) => {
            if (e.target === modal) { // Check if the click was directly on the modal background
                closeModal();
            }
        });

        // Initial data fetch when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
